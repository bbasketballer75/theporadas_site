name: codeql-finalize-baseline

on:
  workflow_dispatch:
  workflow_run:
    workflows: ['codeql']
    types: [completed]

permissions:
  contents: write
  actions: read
  security-events: read

jobs:
  finalize:
    if: >-
      ${{ github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    name: Finalize CodeQL Baseline
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Node (for snapshot script)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Run snapshot script (fresh fetch)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          CODEQL_RUN_NUMBER: ${{ github.run_number }}
          CODEQL_GATING_REMOVAL_SHA: ${{ github.sha }}
        run: |
          node scripts/codeql_baseline_snapshot.mjs
          echo '--- Snippet Preview (first 40 lines) ---'
          sed -n '1,40p' artifacts/codeql-baseline-snippet.md

      - name: Replace placeholder in SECURITY_NOTES.md
        run: |
          set -e
          if ! grep -q '^## CodeQL Baseline (Public Repo Transition Placeholder)' SECURITY_NOTES.md; then
            echo 'No placeholder baseline section found; skipping replacement.'
            exit 0
          fi
          # Create temp file with everything before placeholder
          awk '/^## CodeQL Baseline (Public Repo Transition Placeholder)/ {exit} {print}' SECURITY_NOTES.md > SECURITY_NOTES.new
          echo '' >> SECURITY_NOTES.new
          cat artifacts/codeql-baseline-snippet.md >> SECURITY_NOTES.new
          echo '' >> SECURITY_NOTES.new
          # Append remainder after placeholder block: skip until next header after the placeholder line
          awk 'foundPlaceholder==0 { if ($0 ~ /^## CodeQL Baseline (Public Repo Transition Placeholder)/) {foundPlaceholder=1; next} else {next} } foundPlaceholder==1 { if ($0 ~ /^## /) {start=1} if (start) print }' SECURITY_NOTES.md >> SECURITY_NOTES.new || true
          mv SECURITY_NOTES.new SECURITY_NOTES.md
          echo 'Baseline placeholder replaced.'

      - name: Commit changes
        run: |
          if git diff --quiet SECURITY_NOTES.md; then
            echo 'No changes to commit.'
            exit 0
          fi
          git config user.name 'github-actions'
          git config user.email 'github-actions@users.noreply.github.com'
          git add SECURITY_NOTES.md artifacts/codeql-alert-counts.json artifacts/codeql-alerts.json artifacts/codeql-baseline-snippet.md
          git commit -m 'chore(security): finalize CodeQL baseline counts (closes #24)'
          git push
