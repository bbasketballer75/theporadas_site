name: codeql-finalize-baseline

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  finalize:
    name: Finalize CodeQL Baseline
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download latest CodeQL baseline artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: codeql-baseline-artifacts-*
          path: tmp-artifacts
          merge-multiple: true

      - name: Show artifacts
        run: ls -R tmp-artifacts || true

      - name: Prepare replacement snippet
        id: prep
        run: |
          if [ ! -f tmp-artifacts/codeql-baseline-snippet.md ]; then
            echo 'Missing snippet artifact; aborting.' >&2
            exit 1
          fi
          echo '--- Snippet Preview ---'
          sed -n '1,40p' tmp-artifacts/codeql-baseline-snippet.md

      - name: Replace placeholder in SECURITY_NOTES.md
        run: |
          set -e
          placeholder_start_line=$(grep -n '^## CodeQL Baseline (Public Repo Transition Placeholder)' SECURITY_NOTES.md | cut -d: -f1 || true)
          if [ -z "$placeholder_start_line" ]; then
            echo 'No placeholder header found; aborting to avoid duplicate baseline.' >&2
            exit 2
          fi
          # We'll keep everything before the placeholder, then append the new snippet, then keep the remainder after the placeholder block separator.
          awk -v pl=$placeholder_start_line 'NR<pl' SECURITY_NOTES.md > SECURITY_NOTES.new
          echo '' >> SECURITY_NOTES.new
          cat tmp-artifacts/codeql-baseline-snippet.md >> SECURITY_NOTES.new
          echo '' >> SECURITY_NOTES.new
          # Append the remainder AFTER the placeholder section. We detect end of placeholder by finding the next markdown header starting with ## (excluding the placeholder itself) after the placeholder line.
          # Simpler: skip lines from placeholder header until a line that starts with "## " and is NOT the placeholder header (or end of file) AFTER first.
          awk -v pl=$placeholder_start_line 'NR<=pl {next} /^## CodeQL Baseline \(Public Repo Transition Placeholder\)/ {next} /^## / {found=1} !found {next} {print}' SECURITY_NOTES.md >> SECURITY_NOTES.new || true
          mv SECURITY_NOTES.new SECURITY_NOTES.md
          echo 'Replacement complete.'

      - name: Commit changes
        run: |
          if git diff --quiet SECURITY_NOTES.md; then
            echo 'No changes to commit (placeholder may have been absent).'
            exit 0
          fi
          git config user.name 'github-actions'
            git config user.email 'github-actions@users.noreply.github.com'
          git add SECURITY_NOTES.md
          git commit -m 'chore(security): finalize CodeQL baseline counts (closes #24)'
          git push
