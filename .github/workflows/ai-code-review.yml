name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  run-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci --workspaces

      - name: Lint
        run: npm run lint

      - name: Run tests
        run: npm test -- --json --outputFile=artifacts/jest-results.json

      - name: Run accessibility tests
        run: npm test -- __tests__/Greeting.a11y.test.jsx -- --json --outputFile=artifacts/jest-a11y.json || true

  ai-judge:
    needs: run-checks
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Create AI review summary and label
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr) { core.info('No PR context'); return; }
            const checksPassed = (needs.run-checks.result === 'success');
            const labelsToAdd = checksPassed ? ['ai-approved'] : ['ai-needs-work'];

            // Ensure labels exist (create if missing)
            const existingLabels = await github.issues.listLabelsForRepo({ owner: context.repo.owner, repo: context.repo.repo });
            const existingNames = new Set(existingLabels.data.map(l => l.name));
            for (const l of labelsToAdd) {
              if (!existingNames.has(l)) {
                await github.issues.createLabel({ owner: context.repo.owner, repo: context.repo.repo, name: l, color: (l === 'ai-approved' ? '0E8A16' : 'B60205'), description: (l === 'ai-approved' ? 'Approved by AI checks' : 'Requires attention from author') });
              }
            }

            await github.issues.addLabels({ owner: context.repo.owner, repo: context.repo.repo, issue_number: pr.number, labels: labelsToAdd });

            const body = checksPassed ? 'AI review: all automated checks passed. Labelled with `ai-approved` and eligible for auto-merge.' : 'AI review: some automated checks failed. Labelled with `ai-needs-work`. Please review the build/test output and address failures.';
            await github.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: pr.number, body });
