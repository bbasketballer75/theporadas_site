# Multi-stage minimal Node image for MCP servers
FROM node:20-alpine AS base
WORKDIR /app
ENV HUSKY=0
COPY package.json package-lock.json* pnpm-lock.yaml* ./
# Install only production deps (husky disabled via HUSKY=0)
RUN if [ -f pnpm-lock.yaml ]; then npm install -g pnpm && pnpm install --prod --ignore-scripts; \
    else npm install --omit=dev --ignore-scripts; fi
COPY scripts ./scripts
COPY src ./src
COPY docs ./docs
# Include memory bank content (read-only unless volume mounted)
COPY memory-bank ./memory-bank
# Provide non-root user
RUN addgroup -S mcp && adduser -S mcp -G mcp
USER mcp
ENV NODE_OPTIONS=--enable-source-maps
# Default command expects SERVER entrypoint env var (e.g., scripts/mcp_tavily.mjs)
ENTRYPOINT ["node"]
CMD ["scripts/mcp_tavily.mjs"]
